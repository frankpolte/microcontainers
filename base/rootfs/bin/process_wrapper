#!/bin/sh
# Generic process wrapper script
#
# https://mmonit.com/wiki/Monit/FAQ
# https://stackoverflow.com/questions/23454344/use-monit-monitor-a-python-program
#
# (c) 2017 Martin Haso≈à <martin.hason@gmail.com>

action=$1
name=$2
shift
shift

case $action in
    start)
        _i=0;
        command="/sbin/tini -s -g -- $@"
        eval "$command" &
        while [ -z "$(pgrep -o -f -x "$command")" ]; do
            sleep 1
            _i="$("$_i" + 1)"

            if [ "$_i" -ge 5 ]; then
                printf "\033[30;41mUnable to start process \"%s\"\033[0m\n" "$@" >&2
                exit 1;
            fi
        done
        echo "$(pgrep -o -f -x "$command")" > "/var/run/$name.pid";
        ;;
    stop)
        kill "$(cat "/var/run/$name.pid")"
        rm -f "/var/run/$name.pid"
        ;;
    *)
        echo "usage: process_wrapper {start|stop} name [command]" ;;
esac
exit 0
